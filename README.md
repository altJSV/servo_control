# Servo control
Управление нексолькими серво-приводами через Яндекс Алису и веб интерфейс

## Настройки
Укажите здесь учетные данные для подключения к вашей точке доступа WiFi
> //Логин- пароль wifi
> #define ssid  "ssid" //точка доступа wifi
> #define password  "pass" //пароль wifi

Далее учетные данные для подключения к MQTT брокеру
> //mqtt
> const char* mqtt_server = "192.168.1.1"; //ip или http адрес
> int mqtt_port = 1883; //порт
> const char* mqtt_login="login"; //логин
> const char* mqtt_pass="pass"; //пароль

Здесь укажите колличество подключенных сервоприводов и максимальный угол поворота (0-180) 
> #define AMOUNT 2 //количество сервоприводов
> #define MAXANGLE 90 //максимальный угол поворота

В функции Setup() укажите пины ESP8266 к которым подключены управляющие провода серво-приводов
> 	servos[0].attach(D3);
>   servos[0].smoothStart();
>   servos[1].attach(D4);
>   servos[1].smoothStart();
>   //servos[2].attach(5);
>   //servos[2].smoothStart();
>   //servos[3].attach(6);
>   //servos[3].smoothStart();

## Сборка проекта
Для корректной сборки используйте ядро ESP8266 для Arduino IDE верси не ниже 2.7.4 и библиотеки из папки libs проекта

## Веб интерфейс
При подключении к вашей сети WiFi ESP8266 поднимает веб интерфейс на 80 порту. IP адрес для подключения выводится в мониторе серийного порта Arduino IDE. Введите его в адресную строку вашего браузера.
В открывшемся веб интерфейсе выберите в выпадающем нужный вам сервопривод и спомощью ползунка установите процент поворота до максимального угла. Нажмите кнопку Применить для выполнения команды. Для управления всеми сервоприводами одновременно выберите в выпадающем списке пункт Все.

## Управление по MQTT
При подключении к MQTT брокеру устройство создает топик **StatusTopic** где публикует информацию о своем статусе. Также оно подписывается на топик **CmdTopic** для приема команд.

### Формат команд
Устройство понимает следующий формат команд:
**N %%%**
Где N - номер сервопривода от 0 до AMOUNT-1
%%% - процент поворота
При N=AMOUNT команда выполняется для всех серво одновременно

## Настройка навыка Алисы через Домовенок Кузя
Возможны 2 варианта управления устройством. Непосредственно через Навык Домовенок Кузя. В таком случае команда управления будет звучать примерно так:
> Алиса, попроси домовенка Кузю открыть клапан 1 на 50 процентов

или 
> Алиса, попроси домовенка Кузю открыть клапан 0 на 100

Либо же второй вариант через виртуальное устройство умного дома
Воздушных заслонки Кузя пока не поддерживает, так что наиболее близким мне показался аналог умной лампы. Хотя возможны и другие альтернативы.
### Управление через навык Домовенок Кузя
Переходим по адресу https://alexstar.ru/smarthome и создаем новое правило MQTT
![](/adds/kuzya_full_control.png)
Далее откройте навык Домовенок Кузя на устройстве с которого планируете управлять клапанами и введите или продиктуйте код указанный стрелкой:
![](/adds/code.png)
### Управление через виртуальное устройство
Перейдите по адресу https://alexstar.ru/smarthome и создайте несколько новых правил MQTT для каждого из клапанов:
![](/adds/vdevice_on.png)
![](/adds/vdevice_off.png)
![](/adds/vdevice_percent.png)

Далее перейдите по адресу https://alexstar.ru/smarthome/devices и создайте новое устройство типа Лампа со следующими параметрами:

![](/adds/vdevice_setting.png)
Далее в устройствах умного дома на смартфоне кнопкой Включить/выключить открывать и закрывать задвижку, а установкой яркости менять ее положение

